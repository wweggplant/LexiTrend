# Story 1.1: 项目初始化和开发环境配置

## Status: Review

## Story

- As a 开发工程师
- I want 建立一个完整的开发环境，包括项目结构、构建工具和基础配置
- so that 可以开始Chrome扩展开发，确保代码质量和开发效率

## Acceptance Criteria (ACs)

1. ✅ Vite + React + TypeScript 项目已初始化
2. ✅ TailwindCSS 已配置并可正常使用
3. ✅ Chrome Extension Manifest V3 已配置
4. ✅ 项目目录结构符合技术规范要求
5. ✅ Git 仓库已初始化，包含适当的 .gitignore
6. ✅ package.json 包含所有必要的开发和构建脚本
7. ✅ ESLint 和 Prettier 已配置
8. ✅ 开发环境可以正常启动并支持热重载

## Tasks / Subtasks

- [x] Task 1: 初始化项目基础架构 (AC: 1, 4)
  - [x] 创建新的 Vite + React + TypeScript 项目
  - [x] 配置 tsconfig.json 使用严格模式
  - [x] 设置推荐的项目目录结构：
    - `src/components/` (React 组件)
    - `src/services/` (核心服务层)
    - `src/utils/` (工具函数)
    - `src/types/` (TypeScript 类型定义)
    - `src/hooks/` (自定义 React Hooks)
    - `src/constants/` (常量定义)
    - `public/` (静态资源和manifest)

- [x] Task 2: 配置构建工具和样式系统 (AC: 2, 6)
  - [x] 安装和配置 TailwindCSS
  - [x] 配置 Vite 构建设置，支持多入口点：
    - popup.html (弹窗页面)
    - sidepanel.html (侧边栏页面)
    - background.ts (Service Worker)
    - content-script.ts (内容脚本)
  - [x] 设置输出文件命名规则避免hash冲突
  - [x] 配置开发服务器支持热重载

- [x] Task 3: Chrome Extension 配置 (AC: 3)
  - [x] 创建 public/manifest.json 文件
  - [x] 配置 Manifest V3 必需字段：
    - manifest_version: 3
    - name, version, description
    - permissions: ["storage", "activeTab", "sidePanel"]
    - host_permissions: ["https://trends.google.com/*", "https://generativelanguage.googleapis.com/*"]
  - [x] 配置 background service worker
  - [x] 配置 content scripts 匹配规则
  - [x] 配置 action (popup) 和 side_panel

- [x] Task 4: 代码质量工具配置 (AC: 7)
  - [x] 安装和配置 ESLint：
    - React Hooks 规则
    - TypeScript 规则
    - 禁用生产环境 console.log
  - [x] 安装和配置 Prettier：
    - 2空格缩进
    - 单引号
    - 尾逗号 (es5)
    - 行宽 80 字符
  - [x] 创建 .editorconfig 文件
  - [x] 配置 husky 和 lint-staged (可选)

- [x] Task 5: 版本控制和脚本配置 (AC: 5, 6)
  - [x] 初始化 Git 仓库
  - [x] 创建 .gitignore 文件包含：
    - node_modules/
    - dist/
    - .env
    - *.log
    - .DS_Store
  - [x] 配置 package.json scripts：
    - `dev`: 开发环境启动
    - `build`: 生产构建
    - `build:prod`: 生产环境优化构建
    - `package`: 打包扩展为zip
    - `lint`: ESLint 检查
    - `type-check`: TypeScript 类型检查

- [x] Task 6: 验证开发环境 (AC: 8)
  - [x] 创建简单的 Hello World 组件测试 React 渲染
  - [x] 验证 TailwindCSS 样式正常加载
  - [x] 测试热重载功能正常工作
  - [x] 验证 TypeScript 编译无错误
  - [x] 确保扩展可以加载到 Chrome 开发环境

## Dev Technical Guidance

### 关键配置参考

**Vite 配置要点** (参考 `docs/dev-guide.md#vite-config`):
```typescript
// vite.config.ts 关键配置
build: {
  rollupOptions: {
    input: {
      popup: resolve(__dirname, 'popup.html'),
      sidepanel: resolve(__dirname, 'sidepanel.html'),
      background: resolve(__dirname, 'src/background.ts'),
      content: resolve(__dirname, 'src/content-script.ts'),
    }
  }
}
```

**TypeScript 严格配置** (参考 `docs/tech-spec.md#typescript-config`):
- 启用 `strict: true`
- 启用 `noImplicitReturns: true`
- 启用 `noUncheckedIndexedAccess: true`

**Chrome Extension 权限配置**:
- 必须包含 `sidePanel` 权限以支持侧边栏功能
- host_permissions 必须包含 Google Trends 和 Gemini API 域名

### 项目结构对齐

确保创建的目录结构与 `docs/tech-spec.md#项目结构` 完全一致：
- 所有服务类应放在 `src/services/` 目录
- React 组件按功能模块分组 (`ui/`, `onboarding/`, `sidepanel/`)
- 类型定义统一管理在 `src/types/`

### 开发环境验证清单

1. ✅ `pnpm run dev` 能正常启动开发服务器
2. ✅ 访问 localhost 能看到默认页面
3. ✅ 修改代码能触发热重载
4. ✅ `pnpm run build:prod` 能成功构建
5. ✅ Chrome 开发者模式能加载构建后的扩展

### 重要解决方案记录

**@crxjs/vite-plugin TypeScript 配置**:
- 在 manifest.json 中直接使用 `.ts` 扩展名
- 使用 `pnpm run build:prod` 而非 `pnpm run build` 进行生产构建
- 确保service-worker-loader.js不包含localhost开发环境引用

### 测试指导

**单元测试设置**:
- 安装 Jest 和 @testing-library/react
- 配置测试环境支持 TypeScript 和 JSX
- 创建简单的组件渲染测试验证环境

**集成测试**:
- 验证 Vite 构建输出正确的文件结构
- 测试 Chrome Extension manifest 验证通过
- 确保所有配置的脚本命令正常执行

**验收测试场景**:
1. ✅ 开发者可以使用 `pnpm install` 安装依赖
2. ✅ 运行 `pnpm dev` 启动开发环境
3. ✅ 运行 `pnpm build:prod` 生成可加载的扩展文件
4. ✅ 在 Chrome 中加载扩展不出现错误
5. ✅ 代码修改能触发热重载更新

## Story Progress Notes

### Agent Model Used: `Frontend Developer Ellyn`

### Final Implementation Status

**✅ 所有任务已完成 (100%)**
1. 项目基础架构 - Vite + React + TypeScript + 严格模式配置 ✅
2. TypeScript严格模式配置和编译验证 ✅
3. TailwindCSS 配置和路径优化 ✅
4. 项目目录结构创建 ✅
5. ESLint 和 Prettier 配置文件 ✅
6. EditorConfig 配置 ✅
7. package.json 脚本更新 ✅
8. .gitignore 优化 ✅
9. Manifest V3 配置 ✅
10. HTML 入口点创建 (popup.html, sidepanel.html) ✅
11. 基础React组件和入口点 ✅
12. Chrome Extension构建和加载验证 ✅

**🔧 关键问题解决:**
1. **@crxjs/vite-plugin TypeScript支持** - 在manifest.json中使用.ts扩展名
2. **service-worker-loader.js错误** - 使用`build:prod`命令生成正确的生产构建
3. **项目结构对齐** - 创建符合tech-spec要求的目录布局
4. **工具函数缺失** - 创建utils.ts和use-mobile.ts解决依赖问题

**📊 最终验收状态:**
- ✅ **8/8 验收标准全部完成**
- ✅ **所有构建和部署测试通过**
- ✅ **Chrome Extension在开发和生产环境正常工作**

### Completion Notes List

- 2025-01-11 16:32: 开始Story 1.1实施，状态更新为InProgress
- 2025-01-11 16:45: 完成基础架构配置，包括目录结构和TypeScript配置
- 2025-01-11 16:50: 完成TailwindCSS和Vite配置
- 2025-01-11 17:00: 完成Chrome Extension Manifest和HTML入口点
- 2025-01-11 17:10: 完成代码质量工具配置(ESLint/Prettier/EditorConfig)
- 2025-01-11 17:15: 完成package.json脚本和.gitignore更新
- 2025-01-11 17:20: 创建基础React组件和工具函数
- 2025-01-11 17:25: 遇到构建问题，需要修复crx插件配置
- 2025-01-11 17:40: 解决@crxjs/vite-plugin TypeScript配置问题
- 2025-01-11 17:45: 修复service-worker-loader.js构建问题
- 2025-01-11 17:50: 完成所有验收测试，Story状态更新为Review

### Change Log

- 2025-01-XX: Story created by Scrum Master Bob
- 基于 task-breakdown.md Sprint 1 阶段 1.1 任务创建
- 技术指导参考 tech-spec.md 和 dev-guide.md
- 2025-01-11: 开始实施，Frontend Developer Ellyn接手
- 2025-01-11: 解决构建配置问题并完成所有验收标准
- 2025-01-11: Story 1.1 完成，准备进入Review阶段 